name: ðŸ§ª Build & Test

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
    branches:
      - main
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

jobs:
  build-test:
    runs-on: windows-latest
    name: Build and unit test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore classic NuGet packages
        run: nuget restore TopWinPrio.sln

      - name: Restore SDK-style/PackageReference dependencies  
        run: dotnet restore TopWinPrio.Tests/TopWinPrio.Tests.csproj

      - name: Build Release configuration
        run: msbuild TopWinPrio.sln /p:Configuration=Release /m /p:Platform="Any CPU"

      - name: Run unit tests
        run: dotnet test TopWinPrio.Tests/TopWinPrio.Tests.csproj --configuration Release --no-build --logger trx

      - name: Capture build logs (Phase 2 preparation)
        run: |
          # KÃ¶r MSBuild igen med verbos logging fÃ¶r StyleCop analys
          msbuild TopWinPrio.sln /p:Configuration=Release /p:RunCodeAnalysis=true /flp:logfile=build-analysis.log /verbosity:normal
        continue-on-error: true

      - name: Generate SHA256 checksums
        run: |
          cd TopWinPrio.CS/bin/Release
          Get-FileHash *.exe, *.dll -Algorithm SHA256 | Select-Object Hash, @{Name="File";Expression={Split-Path $_.Path -Leaf}} | Format-Table -AutoSize | Out-File -FilePath SHA256SUMS.txt -Encoding UTF8
          Get-Content SHA256SUMS.txt

      # Phase 2: VirusTotal scanning (with error handling)
      - name: VirusTotal Scan
        uses: crazy-max/ghaction-virustotal@v4
        continue-on-error: true
        with:
          vt_api_key: ${{ secrets.VIRUSTOTAL_API_KEY }}
          files: |
            TopWinPrio.CS/bin/Release/*.exe
            TopWinPrio.CS/bin/Release/*.dll
          
      - name: Save VirusTotal Results
        run: |
          # Create VirusTotal summary regardless of scan success
          echo "VirusTotal scan attempted at: $(Get-Date)" > TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
          echo "Files processed:" >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt  
          Get-ChildItem TopWinPrio.CS/bin/Release/*.exe, TopWinPrio.CS/bin/Release/*.dll | ForEach-Object { "- $($_.Name)" } >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
          echo "" >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
          echo "VirusTotal Status: Check workflow logs for scan results" >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
          echo "If scan failed, this may be due to:" >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
          echo "- API key issues (401 Unauthorized)" >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
          echo "- Rate limiting (429 Too Many Requests)" >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
          echo "- Network connectivity issues" >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
          echo "" >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
          echo "Manual scan instructions:" >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
          echo "1. Download the release artifacts" >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
          echo "2. Visit https://www.virustotal.com/gui/home/upload" >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
          echo "3. Upload TopWinPrio.exe for manual scanning" >> TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt
        continue-on-error: true

      - name: Upload Release binaries
        uses: actions/upload-artifact@v4
        with:
          name: release-bin
          path: |
            TopWinPrio.CS/bin/Release/*.exe
            TopWinPrio.CS/bin/Release/*.dll
            TopWinPrio.CS/bin/Release/SHA256SUMS.txt
            TopWinPrio.CS/bin/Release/VirusTotal-Summary.txt

      - name: Upload build analysis logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: |
            build-analysis.log

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            **/TestResults/**/*.trx
