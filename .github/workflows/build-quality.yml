name: ğŸ§ª Build & Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  quality-check:
    name: ğŸ” Build, Test & Scan
    runs-on: windows-latest

    steps:
      # -----------------------------
      # 1ï¸âƒ£ Setup & Build
      # -----------------------------
      - name: ğŸ§­ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: ğŸ› ï¸ Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: âš™ï¸ Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: ğŸ“¥ Restore packages
        run: |
          nuget restore TopWinPrio.sln
          dotnet restore TopWinPrio.Tests/TopWinPrio.Tests.csproj

      - name: ğŸ—ï¸ Build solution
        run: msbuild TopWinPrio.sln /t:Build /p:Configuration=Release

      - name: ğŸ§ª Run tests
        run: dotnet test TopWinPrio.Tests/TopWinPrio.Tests.csproj --configuration Release --no-restore --logger trx

      # -----------------------------
      # 2ï¸âƒ£ Security Scans
      # -----------------------------

      - name: ğŸ§¯ Scan with Windows Defender
        id: defender
        shell: pwsh
        run: |
          $exe = "TopWinPrio.CS\bin\Release\TopWinPrio.exe"
          if (Test-Path $exe) {
            Write-Host "ğŸ§  Scanning $exe with Windows Defender..."
            $defender = "C:\Program Files\Windows Defender\MpCmdRun.exe"
            $result = & $defender -Scan -ScanType 3 -File $exe
            $exit = $LASTEXITCODE
            if ($exit -eq 0) {
              Write-Host "âœ… Defender scan passed."
              echo "result=Clean" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host "âš ï¸ Defender scan found potential issue (exit code: $exit)"
              echo "result=Warning" >> $env:GITHUB_OUTPUT
            }
          } else {
            Write-Host "âš ï¸ No executable found to scan."
            echo "result=Skipped" >> $env:GITHUB_OUTPUT
          }

      - name: ğŸ§¬ VirusTotal Scan (optional)
        if: ${{ secrets.VIRUSTOTAL_API_KEY != '' }}
        id: virustotal
        uses: crazy-max/ghaction-virustotal@v4
        with:
          vt_api_key: ${{ secrets.VIRUSTOTAL_API_KEY }}
          files: TopWinPrio.CS/bin/Release/TopWinPrio.exe
          fail_on_detected: false

      # -----------------------------
      # 3ï¸âƒ£ Generate report
      # -----------------------------
      - name: ğŸ§¾ Generate summary report
        shell: pwsh
        run: |
          $report = @()
          $report += "# ğŸ§ª Build & Test Report"
          $report += ""
          $report += "## âœ… Build Status"
          $report += "Solution built successfully with MSBuild (.NET Framework 3.5)."
          $report += ""
          $report += "## ğŸ§ª Test Results"
          $report += "All unit tests executed successfully."
          $report += ""
          $report += "## ğŸ›¡ï¸ Security Scans"
          $report += ""
          $report += "### ğŸ”¹ Windows Defender"
          $report += "Result: **${{ steps.defender.outputs.result }}**"
          $report += ""
          if ("${{ steps.virustotal.outcome }}" -ne "") {
            $report += "### ğŸ”¹ VirusTotal"
            $report += "Result: **${{ steps.virustotal.outcome }}**"
            $report += "Report: [View Scan on VirusTotal](${{ steps.virustotal.outputs.permalink }})"
            $report += ""
          } else {
            $report += "### ğŸ”¹ VirusTotal"
            $report += "Result: *(skipped â€” no API key configured)*"
            $report += ""
          }
          $report += "## ğŸ“‹ Code Analysis"
          $report += "See full analysis in:"
          $report += "- [SonarCloud Analysis](https://github.com/MarcusMedina/TopWinPrio/actions/workflows/sonarcloud.yml)"
          $report += ""
          $report += "_Report generated on $(Get-Date -Format u)_"
          $report | Out-File -FilePath quality-report.md -Encoding UTF8

      - name: ğŸ“¤ Upload Quality Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality-report.md
