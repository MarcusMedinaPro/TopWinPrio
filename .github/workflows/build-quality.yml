name: ðŸ§ª Build & Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  quality-check:
    name: ðŸ” Build, Test & Scan
    runs-on: windows-latest

    steps:
      # -----------------------------
      # 1ï¸âƒ£ Setup & Build
      # -----------------------------
      - name: ðŸ§­ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: ðŸ› ï¸ Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: âš™ï¸ Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: ðŸ“¥ Restore packages
        run: |
          nuget restore TopWinPrio.sln
          dotnet restore TopWinPrio.Tests/TopWinPrio.Tests.csproj

      - name: ðŸ—ï¸ Build solution
        run: msbuild TopWinPrio.sln /t:Build /p:Configuration=Release

      - name: ðŸ§ª Run tests
        run: dotnet test TopWinPrio.Tests/TopWinPrio.Tests.csproj --configuration Release --no-restore --logger trx

      # -----------------------------
      # 2ï¸âƒ£ Security Scans
      # -----------------------------

      - name: ðŸ§¯ Scan with Windows Defender
        id: defender
        shell: pwsh
        run: |
          $exe = "TopWinPrio.CS\bin\Release\TopWinPrio.exe"
          if (Test-Path $exe) {
            Write-Host "ðŸ§  Scanning $exe with Windows Defender..."
            $defender = "C:\Program Files\Windows Defender\MpCmdRun.exe"
            & $defender -Scan -ScanType 3 -File $exe
            if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ… Defender scan passed."
              echo "result=Clean" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host "âš ï¸ Defender scan found potential issue (exit code: $LASTEXITCODE)"
              echo "result=Warning" >> $env:GITHUB_OUTPUT
            }
          } else {
            Write-Host "âš ï¸ No executable found to scan."
            echo "result=Skipped" >> $env:GITHUB_OUTPUT
          }

      - name: ðŸ§¬ VirusTotal Scan (optional)
        id: virustotal
        env:
          VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
        if: ${{ env.VIRUSTOTAL_API_KEY }}
        uses: crazy-max/ghaction-virustotal@v4
        with:
          vt_api_key: ${{ secrets.VIRUSTOTAL_API_KEY }}
          files: TopWinPrio.CS/bin/Release/TopWinPrio.exe
          fail_on_detected: false

      # -----------------------------
      # 3ï¸âƒ£ Signature Verification
      # -----------------------------
      - name: ðŸ” Verify Digital Signature
        id: signature
        shell: pwsh
        run: |
          $exe = "TopWinPrio.CS\bin\Release\TopWinPrio.exe"
          $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\x64\signtool.exe"
          if (Test-Path $exe -and Test-Path $signtool) {
            Write-Host "ðŸ” Verifying digital signature..."
            $verify = & $signtool verify /pa /v $exe 2>&1
            if ($verify -match "Successfully verified") {
              Write-Host "âœ… Signature is valid."
              echo "result=Valid" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host "âš ï¸ Signature verification failed."
              echo "result=Invalid" >> $env:GITHUB_OUTPUT
            }
          } else {
            Write-Host "âš ï¸ No signature tool or file found."
            echo "result=Skipped" >> $env:GITHUB_OUTPUT
          }

      # -----------------------------
      # 4ï¸âƒ£ Generate & Display Report
      # -----------------------------
      - name: ðŸ§¾ Generate summary report
        id: report
        shell: pwsh
        run: |
          $report = @()
          $report += "# ðŸ§ª Build & Test Report"
          $report += ""
          $report += "## âœ… Build Status"
          $report += "Solution built successfully with MSBuild (.NET Framework 3.5)."
          $report += ""
          $report += "## ðŸ§ª Test Results"
          $report += "All unit tests executed successfully."
          $report += ""
          $report += "## ðŸ›¡ï¸ Security Scans"
          $report += ""
          $report += "### ðŸ”¹ Windows Defender"
          $report += "Result: **${{ steps.defender.outputs.result }}**"
          $report += ""
          if ('${{ steps.virustotal.outcome }}' -ne '') {
            $report += "### ðŸ”¹ VirusTotal"
            $report += "Result: **${{ steps.virustotal.outcome }}**"
            $report += "Report: [View on VirusTotal](${{ steps.virustotal.outputs.permalink }})"
            $report += ""
          } else {
            $report += "### ðŸ”¹ VirusTotal"
            $report += "Result: *(skipped â€” no API key configured)*"
            $report += ""
          }
          $report += "### ðŸ”¹ Digital Signature"
          $report += "Result: **${{ steps.signature.outputs.result }}**"
          $report += ""
          $report += "## ðŸ“‹ Code Analysis"
          $report += "See full analysis in:"
          $report += "- [SonarCloud Analysis](https://github.com/MarcusMedina/TopWinPrio/actions/workflows/sonarcloud.yml)"
          $report += ""
          $report += "_Report generated on $(Get-Date -Format u)_"
          $text = $report -join "`n"
          $text | Out-File -FilePath quality-report.md -Encoding UTF8
          echo "$text" >> $env:GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload Quality Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality-report.md
