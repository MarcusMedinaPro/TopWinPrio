name: ğŸ§© Full Quality & Security Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  quality-check:
    name: ğŸ” Analyze, Secure & Test
    runs-on: windows-latest

    steps:
      # 1ï¸âƒ£ Checkout
      - name: ğŸ§­ Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup tooling for legacy WinForms projects
      - name: ğŸ“¦ Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: ğŸ› ï¸ Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: âš™ï¸ Setup .NET SDK (tools)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # 3ï¸âƒ£ Restore & build with classic tooling
      - name: ğŸ“¥ Restore packages
        run: |
          nuget restore TopWinPrio.sln
          dotnet restore TopWinPrio.Tests/TopWinPrio.Tests.csproj

      - name: ğŸ—ï¸ Build solution
        run: msbuild TopWinPrio.sln /t:Build /p:Configuration=Release

      # 4ï¸âƒ£ Tests & coverage (placeholder until automated tests exist)
      - name: ğŸ§ª Run tests
        shell: pwsh
        run: |
          & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe" \
            "${{ github.workspace }}\TopWinPrio.Tests\bin\Release\TopWinPrio.Tests.dll" /logger:trx

      - name: ğŸ“Š Upload coverage to Codecov (if available)
        if: ${{ hashFiles('**/coverage.cobertura.xml') != '' }}
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: "**/coverage.cobertura.xml"
          fail_ci_if_error: false

      # 5ï¸âƒ£ Advanced analysis
      # 6ï¸âƒ£ Summary report
      - name: ğŸ§¾ Generate summary report
        shell: pwsh
        run: |
          $report = @()
          $report += "# ğŸ§© Quality & Security Report"
          $report += ""
          $report += "## ğŸ§  CodeQL"
          $report += "CodeQL scanning is not enabled by default in this pipeline. Configure a dedicated CodeQL workflow to receive code scanning alerts."
          $report += ""
          $report += "## â˜ï¸ SonarCloud"
          $report += "SonarCloud analysis is not part of the default pipeline. Configure it in a separate workflow if needed."
          $report += ""
          $report += "## ğŸ”’ Snyk Vulnerabilities"
          $report += "Snyk scanning is disabled by default. Configure a dedicated Snyk workflow or enable it manually."
          $report += ""
          $report += "## ğŸ“Š Test Coverage"
          if ((Get-ChildItem -Path . -Recurse -Filter coverage.cobertura.xml -ErrorAction SilentlyContinue).Count -gt 0) {
            $report += "Coverage results uploaded to [Codecov](https://app.codecov.io/gh/MarcusMedina/TopWinPrio)."
          } else {
            $report += "Tests executed via MSTest (no coverage collector configured)."
          }
          $report += ""
          $report += "_Report generated on $(Get-Date -Format u)._"
          $report | Out-File -FilePath quality-report.md -Encoding UTF8

      - name: ğŸ“¤ Upload Quality Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality-report.md
