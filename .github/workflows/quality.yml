name: ğŸ§© Full Quality & Security Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  quality-check:
    name: ğŸ” Analyze, Secure & Test
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout
      - name: ğŸ§­ Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup .NET
      - name: âš™ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # 3ï¸âƒ£ Restore dependencies
      - name: ğŸ“¦ Restore
        run: dotnet restore

      # 4ï¸âƒ£ Build solution
      - name: ğŸ—ï¸ Build
        run: dotnet build --configuration Release --no-restore

      # 5ï¸âƒ£ Run tests with coverage
      - name: ğŸ§ª Test
        run: dotnet test --configuration Release --no-build --collect:"XPlat Code Coverage"

      # 6ï¸âƒ£ Upload coverage to Codecov
      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: "**/coverage.cobertura.xml"
          fail_ci_if_error: false

      # 7ï¸âƒ£ Initialize CodeQL
      - name: ğŸ§  Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp

      - name: ğŸ§© Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # 8ï¸âƒ£ SonarCloud Scan
      - name: â˜ï¸ SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=MarcusMedina_TopWinPrio
            -Dsonar.organization=marcusmedina
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.cs.opencover.reportsPaths=**/coverage.cobertura.xml
            -Dsonar.verbose=true

      # 9ï¸âƒ£ Snyk vulnerability scan
      - name: ğŸ”’ Snyk security check
        uses: snyk/actions/dotnet@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --json-file-output=snyk-report.json

      # ğŸ”Ÿ Generate combined markdown summary
      - name: ğŸ§¾ Generate summary report
        run: |
          echo "# ğŸ§© Quality & Security Report" > quality-report.md
          echo "" >> quality-report.md
          echo "## ğŸ§  CodeQL" >> quality-report.md
          echo "Security analysis completed via GitHub CodeQL." >> quality-report.md
          echo "- View details in [Security > Code Scanning Alerts](../../security/code-scanning)" >> quality-report.md
          echo "" >> quality-report.md
          echo "## â˜ï¸ SonarCloud" >> quality-report.md
          echo "Comprehensive code quality report available on [SonarCloud](https://sonarcloud.io/summary/new_code?id=MarcusMedina_TopWinPrio)." >> quality-report.md
          echo "" >> quality-report.md
          echo "## ğŸ”’ Snyk Vulnerabilities" >> quality-report.md
          if [ -f snyk-report.json ]; then
            echo "\`\`\`json" >> quality-report.md
            cat snyk-report.json | jq .vulnerabilities[0:5] >> quality-report.md
            echo "\`\`\`" >> quality-report.md
          else
            echo "Snyk scan completed, no report file found (possibly no vulnerabilities)." >> quality-report.md
          fi
          echo "" >> quality-report.md
          echo "## ğŸ“Š Test Coverage" >> quality-report.md
          echo "Coverage results uploaded to [Codecov](https://app.codecov.io/gh/MarcusMedina/TopWinPrio)." >> quality-report.md
          echo "" >> quality-report.md
          echo "_Report generated on $(date -u)_." >> quality-report.md

      # 1ï¸âƒ£1ï¸âƒ£ Upload markdown report as artifact
      - name: ğŸ“¤ Upload Quality Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality-report.md
