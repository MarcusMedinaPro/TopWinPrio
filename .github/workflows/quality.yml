name: 🧩 Full Quality & Security Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  quality-check:
    name: 🔍 Analyze, Secure & Test
    runs-on: windows-latest

    steps:
      # 1️⃣ Checkout
      - name: 🧭 Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Setup tooling for legacy WinForms projects
      - name: 📦 Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: 🛠️ Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: ⚙️ Setup .NET SDK (tools)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # 3️⃣ Restore & build with classic tooling
      - name: 📥 Restore packages
        run: |
          nuget restore TopWinPrio.sln
          dotnet restore TopWinPrio.Tests/TopWinPrio.Tests.csproj

      - name: 🏗️ Build solution
        run: msbuild TopWinPrio.sln /t:Build /p:Configuration=Release

      # 4️⃣ Tests & coverage (placeholder until automated tests exist)
      - name: 🧪 Run tests
        shell: pwsh
        run: |
          & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe" \
            "${{ github.workspace }}\TopWinPrio.Tests\bin\Release\TopWinPrio.Tests.dll" /logger:trx

      - name: 📊 Upload coverage to Codecov (if available)
        if: ${{ hashFiles('**/coverage.cobertura.xml') != '' }}
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: "**/coverage.cobertura.xml"
          fail_ci_if_error: false

      # 5️⃣ Advanced analysis
      # 6️⃣ Summary report
      - name: 🧾 Generate summary report
        shell: pwsh
        run: |
          $report = @()
          $report += "# 🧩 Quality & Security Report"
          $report += ""
          $report += "## 🧠 CodeQL"
          $report += "CodeQL scanning is not enabled by default in this pipeline. Configure a dedicated CodeQL workflow to receive code scanning alerts."
          $report += ""
          $report += "## ☁️ SonarCloud"
          $report += "SonarCloud analysis is not part of the default pipeline. Configure it in a separate workflow if needed."
          $report += ""
          $report += "## 🔒 Snyk Vulnerabilities"
          $report += "Snyk scanning is disabled by default. Configure a dedicated Snyk workflow or enable it manually."
          $report += ""
          $report += "## 📊 Test Coverage"
          if ((Get-ChildItem -Path . -Recurse -Filter coverage.cobertura.xml -ErrorAction SilentlyContinue).Count -gt 0) {
            $report += "Coverage results uploaded to [Codecov](https://app.codecov.io/gh/MarcusMedina/TopWinPrio)."
          } else {
            $report += "Tests executed via MSTest (no coverage collector configured)."
          }
          $report += ""
          $report += "_Report generated on $(Get-Date -Format u)._"
          $report | Out-File -FilePath quality-report.md -Encoding UTF8

      - name: 📤 Upload Quality Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality-report.md
