name: üöÄ Release - Full Pipeline

on:
  push:
    tags: ["v*"]
    branches: [release, main]

permissions:
  contents: write
  security-events: write

jobs:
  build-and-test:
    runs-on: windows-latest
    name: 1Ô∏è‚É£ Build & Test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore classic NuGet packages
        run: nuget restore TopWinPrio.sln

      - name: Restore SDK-style dependencies
        run: dotnet restore TopWinPrio.Tests/TopWinPrio.Tests.csproj

      - name: Build Release
        run: msbuild TopWinPrio.sln /p:Configuration=Release /m /p:Platform="Any CPU"

      - name: Run unit tests
        run: dotnet test TopWinPrio.Tests/TopWinPrio.Tests.csproj --configuration Release --no-build --logger trx

      - name: Upload unsigned binaries
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-bin
          path: |
            TopWinPrio.CS/bin/Release/net8.0-windows/*.exe
            TopWinPrio.CS/bin/Release/net8.0-windows/*.dll
            !TopWinPrio.CS/bin/Release/net8.0-windows/*.pdb

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: '**/TestResults/**/*.trx'

  quality-gate:
    needs: build-and-test
    runs-on: windows-latest
    name: 2Ô∏è‚É£ Code Quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore packages
        run: dotnet restore TopWinPrio.sln

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
          queries: security-extended,security-and-quality

      - name: Build for CodeQL
        run: dotnet build TopWinPrio.sln --configuration Release --no-restore

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Enhanced Code Analysis
        run: dotnet build TopWinPrio.sln --configuration Release --no-restore /p:TreatWarningsAsErrors=false > CodeAnalysis-Report.log 2>&1
        continue-on-error: true

      - name: Dependency Vulnerability Scan
        run: |
          dotnet list TopWinPrio.Tests/TopWinPrio.Tests.csproj package --vulnerable --include-transitive > vulnerability-report.txt 2>&1 || echo "No vulnerable packages" > vulnerability-report.txt
          Get-Content vulnerability-report.txt
        continue-on-error: true

      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports
          path: |
            CodeAnalysis-Report.log
            vulnerability-report.txt

  code-signing:
    needs: quality-gate
    runs-on: [self-hosted, windows, code-sign]
    name: 3Ô∏è‚É£ Code Signing
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download unsigned binaries
        uses: actions/download-artifact@v4
        with:
          name: unsigned-bin
          path: ./unsigned

      - name: Copy Sign-All.ps1 script
        shell: pwsh
        run: |
          $sourcePath = "C:\Git\Certskit\Sign-All.ps1"
          $destPath = "unsigned\Sign-All.ps1"

          if (Test-Path $sourcePath) {
            Copy-Item $sourcePath $destPath -Force
            Write-Host "‚úÖ Copied Sign-All.ps1" -ForegroundColor Green
          } else {
            Write-Host "‚ùå Sign-All.ps1 not found at $sourcePath" -ForegroundColor Red
            exit 1
          }

      - name: Sign artifacts
        shell: pwsh
        run: |
          Write-Host "Signing artifacts..." -ForegroundColor Cyan
          cd unsigned
          & .\Sign-All.ps1 -SkipDefender

          $signedFiles = Get-ChildItem -Include *.exe, *.dll -Recurse | Where-Object {
            $sig = Get-AuthenticodeSignature $_.FullName
            $sig.Status -eq 'Valid'
          }

          if ($signedFiles.Count -gt 0) {
            Write-Host "‚úÖ Signed $($signedFiles.Count) file(s)" -ForegroundColor Green
          } else {
            Write-Error "No files signed"
            exit 1
          }

      - name: Prepare signed artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path signed | Out-Null

          $files = Get-ChildItem -Path unsigned -Include *.exe, *.dll -Recurse
          foreach ($f in $files) {
            Copy-Item $f.FullName signed/ -Force
            $sig = Get-AuthenticodeSignature $f.FullName
            if ($sig.Status -eq 'Valid') {
              Write-Host "‚úÖ $($f.Name)" -ForegroundColor Green
            } else {
              Write-Host "‚ö†Ô∏è  $($f.Name) - Status: $($sig.Status)" -ForegroundColor Yellow
            }
          }

          if (Test-Path "unsigned\sign_log.txt") {
            Copy-Item "unsigned\sign_log.txt" signed/ -Force
          }

      - name: Upload signed artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signed-bin
          path: signed/

  antivirus-scan:
    needs: code-signing
    runs-on: windows-latest
    name: 4Ô∏è‚É£ Antivirus Scan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download signed binaries
        uses: actions/download-artifact@v4
        with:
          name: signed-bin
          path: ./signed

      - name: Generate SHA256 checksums
        run: |
          cd signed
          Get-FileHash *.exe, *.dll -Algorithm SHA256 | Select-Object Hash, @{Name="File";Expression={Split-Path $_.Path -Leaf}} | Format-Table -AutoSize | Out-File -FilePath SHA256SUMS.txt -Encoding UTF8
          Get-Content SHA256SUMS.txt

      - name: VirusTotal Scan
        uses: crazy-max/ghaction-virustotal@v4
        id: virustotal
        continue-on-error: true
        with:
          vt_api_key: ${{ secrets.VIRUSTOTAL_API_KEY }}
          files: |
            signed/*.exe
            signed/*.dll
          vt_monitor: false

      - name: Save VirusTotal Results
        run: |
          $summary = "VirusTotal Scan Report - " + (Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC") + "`n"
          $summary += "================================================================`n`n"

          if ("${{ steps.virustotal.outcome }}" -eq "success") {
            $summary += "‚úÖ VirusTotal scan completed successfully`n"
          } elseif ("${{ steps.virustotal.outcome }}" -eq "failure") {
            $summary += "‚ö†Ô∏è  VirusTotal scan failed (possibly 409 duplicate - files already scanned)`n"
            $summary += "This is normal for re-releases and does not indicate problems`n"
          } else {
            $summary += "‚ÑπÔ∏è  VirusTotal scan status: ${{ steps.virustotal.outcome }}`n"
          }

          $summary += "`nFiles Scanned:`n"
          Get-ChildItem signed/*.exe, signed/*.dll | ForEach-Object {
            $fileSizeKB = [math]::Round($_.Length/1024, 2)
            $summary += "- $($_.Name) ($fileSizeKB KB)`n"
          }

          $summary | Out-File -FilePath "signed/VirusTotal-Summary.txt" -Encoding UTF8
          Get-Content signed/VirusTotal-Summary.txt

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: |
            signed/SHA256SUMS.txt
            signed/VirusTotal-Summary.txt

  publish-release:
    needs: antivirus-scan
    runs-on: windows-latest
    name: 5Ô∏è‚É£ Publish Release
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download signed binaries
        uses: actions/download-artifact@v4
        with:
          name: signed-bin
          path: ./signed-bin

      - name: Download scan results
        uses: actions/download-artifact@v4
        with:
          name: scan-results
          path: ./scan-results

      - name: Create release packages
        run: |
          New-Item -ItemType Directory -Path "release-packages" -Force

          if (Test-Path "Manual.pdf") {
            Copy-Item "Manual.pdf" -Destination "signed-bin/Manual.pdf"
          }

          Compress-Archive -Path "signed-bin/*" -DestinationPath "release-packages/TopWinPrio-release.zip"
          Compress-Archive -Path "signed-bin/*.exe" -DestinationPath "release-packages/TopWinPrio-exe-only.zip"
          Copy-Item "signed-bin/TopWinPrio.exe" -Destination "release-packages/TopWinPrio.exe"

          Get-ChildItem -Path "release-packages" -Recurse

      - name: Generate release checksums
        run: |
          cd release-packages
          Get-ChildItem -File | Where-Object { $_.Name -ne "SHA256SUMS.txt" } | Get-FileHash -Algorithm SHA256 | Select-Object Hash, @{Name="File";Expression={$_.Path | Split-Path -Leaf}} | Format-Table -AutoSize | Out-File -FilePath SHA256SUMS.txt -Encoding UTF8
          Get-Content SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-packages/TopWinPrio-release.zip
            release-packages/TopWinPrio-exe-only.zip
            release-packages/TopWinPrio.exe
            release-packages/SHA256SUMS.txt
            scan-results/VirusTotal-Summary.txt
          generate_release_notes: true
          draft: false
          prerelease: false
