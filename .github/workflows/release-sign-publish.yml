name: üß™ Build Test & Scan Quality

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  quality-check:
    runs-on: windows-latest
    name: Build, Test, and Virus Scan
    env:
      HAS_VT_KEY: ${{ secrets.VIRUSTOTAL_API_KEY != '' }}

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install .NET Framework 3.5 Targeting Pack
      - name: üß© Install .NET Framework 3.5 Developer Pack
        shell: pwsh
        run: |
          Write-Host "Installing .NET Framework 3.5 Developer Pack..."
          $url = "https://download.visualstudio.microsoft.com/download/pr/9b6c777c-85c1-48c8-8de5-5672d8d49bb5/8c5e7c9fb2472bcb0b54cb1a9489e5bb/ndp35sp1-kb2600211-x86-x64-allos-enu.exe"
          $installer = "$env:TEMP\ndp35sp1.exe"
          Invoke-WebRequest -Uri $url -OutFile $installer
          Start-Process -FilePath $installer -ArgumentList "/quiet", "/norestart" -Wait
          Write-Host ".NET Framework 3.5 Developer Pack installed successfully."

      # 3Ô∏è‚É£ Setup modern .NET SDK for tooling
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # 4Ô∏è‚É£ Restore & build all projects
      - name: Restore and Build
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore

      # 5Ô∏è‚É£ Run tests (if present)
      - name: Run Unit Tests
        run: dotnet test --configuration Release --no-build --logger trx

      # 6Ô∏è‚É£ Scan with VirusTotal (if API key is provided)
      - name: VirusTotal Scan
        if: env.HAS_VT_KEY == 'true'
        uses: crazy-max/ghaction-virustotal@v4
        with:
          vt_api_key: ${{ secrets.VIRUSTOTAL_API_KEY }}
          files: |
            **/*.exe
            **/*.dll
            **/*.nupkg
          vt_monitor: false

      # 7Ô∏è‚É£ Generate summary report
      - name: Generate Summary Report
        shell: pwsh
        run: |
          $report = @()
          $report += "# üß™ Build & Test Quality Report"
          $report += ""
          $report += "## ‚úÖ Build Status"
          $report += "Solution built successfully targeting .NET Framework 3.5."
          $report += ""
          $report += "## üß™ Test Results"
          $report += "All tests executed successfully."
          $report += ""
          if ($env:HAS_VT_KEY -eq "true") {
            $report += "## üß† VirusTotal"
            $report += "Scan completed ‚Äì see VirusTotal dashboard for details."
          } else {
            $report += "## üß† VirusTotal"
            $report += "Skipped ‚Äì no API key provided."
          }
          $report += ""
          $report += "_Report generated on $(Get-Date -Format u)_"
          $report | Out-File -FilePath quality-report.md -Encoding UTF8
          Get-Content quality-report.md | Write-Host

      # 8Ô∏è‚É£ Upload Quality Report
      - name: Upload Quality Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality-report.md
